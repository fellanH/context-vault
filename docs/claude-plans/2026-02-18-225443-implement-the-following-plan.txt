
    ✻
    |
   ▟█▙     Claude Code v2.1.45
 ▐▛███▜▌   Opus 4.6 · Claude Max
▝▜█████▛▘  ~/dev/context-mcp
  ▘▘ ▝▝  

╭──────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                            │
│                                                                              │
│ Plan: Browser Extension Production Readiness                                 │
│                                                                              │
│ Context                                                                      │
│                                                                              │
│ The Context Vault Chrome extension (packages/extension/) was scaffolded in   │
│ the previous session with sound architecture but is ~70% complete. It cannot │
│  be loaded in Chrome (build output paths are wrong), has no icons (blocking  │
│ for Web Store), and lacks production error handling, onboarding, and polish. │
│  This plan takes it from scaffold to distributable.                          │
│                                                                              │
│ ---                                                                          │
│ Phase 1: Build System Fix (BLOCKING)                                         │
│                                                                              │
│ The current vite.config.ts has three critical issues:                        │
│ 1. Rollup code-splits shared modules into chunks — content scripts can't use │
│  import()                                                                    │
│ 2. Popup HTML outputs at wrong path (preserves src/popup/ prefix, manifest   │
│ expects popup/index.html)                                                    │
│ 3. manifest.json and icons are not copied to dist/                           │
│                                                                              │
│ Solution: Replace vite.config.ts with a scripts/build.mjs that runs 3        │
│ separate Vite builds (popup as HTML app, background as ESM lib, content as   │
│ IIFE lib) then copies static assets.                                         │
│                                                                              │
│ Files                                                                        │
│                                                                              │
│ File: scripts/build.mjs                                                      │
│ Action: New — Multi-step build: popup (React HTML), background (ESM,         │
│   inlineDynamicImports), content (IIFE, inlineDynamicImports), then copy     │
│   manifest + icons                                                           │
│ ────────────────────────────────────────                                     │
│ File: vite.config.ts                                                         │
│ Action: Delete — Replaced by build script                                    │
│ ────────────────────────────────────────                                     │
│ File: package.json                                                           │
│ Action: Update "build" and "dev" scripts to use node scripts/build.mjs       │
│                                                                              │
│ Build output structure                                                       │
│                                                                              │
│ dist/                                                                        │
│   manifest.json          (copied from root)                                  │
│   background.js          (single ESM file)                                   │
│   content.js             (single IIFE file)                                  │
│   icons/                 (copied from root)                                  │
│   popup/                                                                     │
│     index.html           (Vite HTML build output)                            │
│     assets/              (JS + CSS chunks)                                   │
│                                                                              │
│ Verification                                                                 │
│                                                                              │
│ npm run build --workspace=packages/extension                                 │
│ ls dist/  # manifest.json, background.js, content.js, popup/, icons/         │
│ # Load dist/ as unpacked extension in chrome://extensions — no errors        │
│                                                                              │
│ ---                                                                          │
│ Phase 2: Icon Generation                                                     │
│                                                                              │
│ Manifest references icons/icon-{16,32,48,128}.png but no files exist.        │
│ Blocking for Web Store.                                                      │
│                                                                              │
│ Files                                                                        │
│                                                                              │
│ File: assets/icon.svg                                                        │
│ Action: New — Simple vault-door icon, 128x128 viewBox, no text (unreadable   │
│ at                                                                           │
│   16px)                                                                      │
│ ────────────────────────────────────────                                     │
│ File: scripts/generate-icons.mjs                                             │
│ Action: New — Uses sharp to convert SVG → PNG at 16, 32, 48, 128             │
│ ────────────────────────────────────────                                     │
│ File: icons/icon-{16,32,48,128}.png                                          │
│ Action: Generated by script                                                  │
│ ────────────────────────────────────────                                     │
│ File: package.json                                                           │
│ Action: Add sharp to devDependencies, add "icons" script                     │
│                                                                              │
│ ---                                                                          │
│ Phase 3: Manifest Hardening                                                  │
│                                                                              │
│ Changes to manifest.json                                                     │
│                                                                              │
│ - Add "default_title": "Context Vault — Search & Inject" to action           │
│ - Add content_security_policy.extension_pages: "script-src 'self';           │
│ object-src 'self'"                                                           │
│ - Add commands._execute_action with Ctrl+Shift+V / Cmd+Shift+V               │
│ - Improve description for Web Store search relevance                         │
│                                                                              │
│ ---                                                                          │
│ Phase 4: Service Worker Resilience                                           │
│                                                                              │
│ src/background/api-client.ts — Rewrite apiFetch                              │
│                                                                              │
│ - Fetch timeout: 15s via AbortController                                     │
│ - Retry: Up to 2 retries with 1s/3s backoff. No retry on 401/429             │
│ - Rate limit headers: Parse X-RateLimit-Remaining + X-RateLimit-Reset from   │
│ responses, store in chrome.storage.local                                     │
│                                                                              │
│ src/background/index.ts — Badge + improved routing                           │
│                                                                              │
│ - Add updateBadge() — sets red "!" badge on connection failure, clears on    │
│ success                                                                      │
│ - Call updateBadge() after onInstalled, save_settings, test_connection       │
│ - Add comment documenting intentional volatile cachedSettings (falls back to │
│  storage.local)                                                              │
│                                                                              │
│ ---                                                                          │
│ Phase 5: Content Script Hardening                                            │
│                                                                              │
│ All platform adapters — Improved injection chain                             │
│                                                                              │
│ Replace raw <p> append fallback with 3-step chain:                           │
│ 1. document.execCommand("insertText") — works with ProseMirror/Slate         │
│ 2. ClipboardEvent("paste") with DataTransfer — works with paste-aware        │
│ editors                                                                      │
│ 3. Direct textContent set + input event — last resort                        │
│                                                                              │
│ All platform adapters — Resilient selectors                                  │
│                                                                              │
│ Add fallback selector chains. Example for ChatGPT:                           │
│ #prompt-textarea → [data-testid="prompt-textarea"] →                         │
│ div[contenteditable][role="textbox"] → [contenteditable]                     │
│                                                                              │
│ src/content/index.ts — Shadow DOM toast                                      │
│                                                                              │
│ Wrap toast notification in a Shadow DOM host element to prevent CSS          │
│ conflicts with the page.                                                     │
│                                                                              │
│ ---                                                                          │
│ Phase 6: Error Handling & UX Polish                                          │
│                                                                              │
│ New: src/popup/components/ErrorBoundary.tsx                                  │
│                                                                              │
│ React class component error boundary wrapping <App />. Shows error message + │
│  "Try again" button.                                                         │
│                                                                              │
│ src/popup/components/App.tsx                                                 │
│                                                                              │
│ - Not-connected state: When !connected && view === "search", show a "Connect │
│  Your Vault" CTA with description and button to settings (instead of empty   │
│ search bar)                                                                  │
│ - Rate limit warning: Read rateLimitRemaining from chrome.storage.local,     │
│ show subtle warning when < 10                                                │
│                                                                              │
│ src/popup/main.tsx                                                           │
│                                                                              │
│ Wrap <App /> in <ErrorBoundary>.                                             │
│                                                                              │
│ ---                                                                          │
│ Phase 7: Onboarding Flow                                                     │
│                                                                              │
│ New files                                                                    │
│                                                                              │
│ File: src/onboarding/index.html                                              │
│ Purpose: HTML entry for onboarding page                                      │
│ ────────────────────────────────────────                                     │
│ File: src/onboarding/main.tsx                                                │
│ Purpose: React entry point                                                   │
│ ────────────────────────────────────────                                     │
│ File: src/onboarding/components/Onboarding.tsx                               │
│ Purpose: 3-step flow: Welcome → Connect → Done                               │
│                                                                              │
│ 3-step flow (~60 seconds)                                                    │
│                                                                              │
│ 1. Welcome: Extension name, 3 bullet points of what it does                  │
│ 2. Connect: Server URL + API key fields, "Test Connection" button (reuses    │
│ settings logic)                                                              │
│ 3. Done: "You're all set!" with tips (keyboard shortcut, right-click to      │
│ save)                                                                        │
│                                                                              │
│ src/background/index.ts                                                      │
│                                                                              │
│ Open onboarding on first install:                                            │
│ if (details.reason === "install") {                                          │
│   chrome.tabs.create({ url: chrome.runtime.getURL("onboarding/index.html")   │
│ });                                                                          │
│ }                                                                            │
│                                                                              │
│ scripts/build.mjs                                                            │
│                                                                              │
│ Add 4th build step for onboarding page (same pattern as popup).              │
│                                                                              │
│ ---                                                                          │
│ Phase 8: Context Menu Enhancement                                            │
│                                                                              │
│ src/background/index.ts                                                      │
│                                                                              │
│ Replace single "Save to Context Vault" item with parent + 4 sub-items:       │
│ - Save as Insight                                                            │
│ - Save as Note                                                               │
│ - Save as Reference                                                          │
│ - Save as Code Snippet                                                       │
│                                                                              │
│ Update onClicked handler to map menuItemId → kind.                           │
│                                                                              │
│ ---                                                                          │
│ Phase 9: Privacy & Web Store Listing                                         │
│                                                                              │
│ New: public/privacy.html                                                     │
│                                                                              │
│ Static privacy policy page bundled with extension:                           │
│ - What data is collected (server URL + API key stored locally, selected text │
│  sent to user's own server)                                                  │
│ - What is NOT done (no analytics, no tracking, no third-party sharing)       │
│ - How to delete data                                                         │
│ - Contact info                                                               │
│                                                                              │
│ Web Store listing prep (not shipped in extension)                            │
│                                                                              │
│ - Category: Productivity                                                     │
│ - Short description (≤132 chars): "Search and inject knowledge from your     │
│ Context Vault into ChatGPT, Claude, and Gemini chats."                       │
│ - Screenshots: 3 at 1280x800 — popup with results, context menu, onboarding  │
│                                                                              │
│ ---                                                                          │
│ Phase 10: Cleanup & Testing                                                  │
│                                                                              │
│ package.json cleanup                                                         │
│                                                                              │
│ Remove unused devDeps: tailwindcss, postcss, autoprefixer                    │
│                                                                              │
│ Manual E2E checklist                                                         │
│                                                                              │
│ 1. npm run build — no errors                                                 │
│ 2. Load dist/ as unpacked — no manifest warnings                             │
│ 3. Icons visible in toolbar at correct size                                  │
│ 4. Fresh install opens onboarding tab                                        │
│ 5. Settings: enter URL + key, test connection succeeds                       │
│ 6. Popup search returns results with scores/tags                             │
│ 7. "Inject into chat" inserts text into ChatGPT input                        │
│ 8. Right-click → "Save to Context Vault" → "as Insight" → toast confirms     │
│ 9. Ctrl+Shift+V opens popup                                                  │
│ 10. Disconnect network → search shows error → reconnect → works              │
│ 11. Badge: red "!" when disconnected, clear when connected                   │
│ 12. No CSP violations in console                                             │
│                                                                              │
│ ---                                                                          │
│ Sequencing                                                                   │
│                                                                              │
│ Phase 1 (Build) ──── MUST be first, everything depends on working build      │
│   │                                                                          │
│   ├─ Phase 2 (Icons) ────────┐                                               │
│   ├─ Phase 3 (Manifest) ─────┤  Can run in parallel                          │
│   │                           │                                              │
│   ├─ Phase 4 (Service Worker) ┤                                              │
│   ├─ Phase 5 (Content Scripts)┤  After build works                           │
│   ├─ Phase 6 (Error/UX) ─────┤                                               │
│   │                           │                                              │
│   ├─ Phase 7 (Onboarding) ───┤  Requires build script update                 │
│   ├─ Phase 8 (Context Menu) ──┤                                              │
│   ├─ Phase 9 (Privacy/Store) ─┘                                              │
│   │                                                                          │
│   └─ Phase 10 (Test/Submit) ──── Last, after everything                      │
│                                                                              │
│ New Files Summary                                                            │
│                                                                              │
│ File: scripts/build.mjs                                                      │
│ Purpose: Multi-step Vite build orchestrator                                  │
│ ────────────────────────────────────────                                     │
│ File: scripts/generate-icons.mjs                                             │
│ Purpose: SVG → PNG icon generation                                           │
│ ────────────────────────────────────────                                     │
│ File: assets/icon.svg                                                        │
│ Purpose: Source icon design                                                  │
│ ────────────────────────────────────────                                     │
│ File: icons/icon-{16,32,48,128}.png                                          │
│ Purpose: Generated icon PNGs                                                 │
│ ────────────────────────────────────────                                     │
│ File: src/popup/components/ErrorBoundary.tsx                                 │
│ Purpose: React error boundary                                                │
│ ────────────────────────────────────────                                     │
│ File: src/onboarding/index.html                                              │
│ Purpose: Onboarding page HTML                                                │
│ ────────────────────────────────────────                                     │
│ File: src/onboarding/main.tsx                                                │
│ Purpose: Onboarding React entry                                              │
│ ────────────────────────────────────────                                     │
│ File: src/onboarding/components/Onboarding.tsx                               │
│ Purpose: 3-step onboarding flow                                              │
│ ────────────────────────────────────────                                     │
│ File: public/privacy.html                                                    │
│ Purpose: Privacy policy page                                                 │
│                                                                              │
│ Modified Files Summary                                                       │
│                                                                              │
│ File: manifest.json                                                          │
│ Changes: default_title, CSP, commands, description                           │
│ ────────────────────────────────────────                                     │
│ File: package.json                                                           │
│ Changes: Scripts, deps cleanup, sharp added                                  │
│ ────────────────────────────────────────                                     │
│ File: vite.config.ts                                                         │
│ Changes: Deleted (replaced by build script)                                  │
│ ────────────────────────────────────────                                     │
│ File: src/background/api-client.ts                                           │
│ Changes: Timeout, retry, rate limit headers                                  │
│ ────────────────────────────────────────                                     │
│ File: src/background/index.ts                                                │
│ Changes: Badge, onboarding redirect, context menu sub-items                  │
│ ────────────────────────────────────────                                     │
│ File: src/content/index.ts                                                   │
│ Changes: Shadow DOM toast                                                    │
│ ────────────────────────────────────────                                     │
│ File: src/content/platforms/chatgpt.ts                                       │
│ Changes: Selector fallbacks, injection chain                                 │
│ ────────────────────────────────────────                                     │
│ File: src/content/platforms/claude.ts                                        │
│ Changes: Selector fallbacks, injection chain                                 │
│ ────────────────────────────────────────                                     │
│ File: src/content/platforms/gemini.ts                                        │
│ Changes: Selector fallbacks, injection chain                                 │
│ ────────────────────────────────────────                                     │
│ File: src/content/platforms/generic.ts                                       │
│ Changes: Improved injection fallback                                         │
│ ────────────────────────────────────────                                     │
│ File: src/popup/main.tsx                                                     │
│ Changes: Wrap in ErrorBoundary                                               │
│ ────────────────────────────────────────                                     │
│ File: src/popup/components/App.tsx                                           │
│ Changes: Not-connected CTA, rate limit warning                               │
╰──────────────────────────────────────────────────────────────────────────────╯

⏺ Let me start by reading the existing extension files to understand the current
   state.

⏺ Explore(Explore extension codebase)
  ⎿  Done (25 tool uses · 44.4k tokens · 1m 5s)
  (ctrl+o to expand)

⏺ Good, I have a thorough understanding of the codebase. This is a large
  implementation — let me create a team to parallelize the work.

⏺ Now let me create the task list and then start Phase 1 (the blocking build
  system fix) first, since everything else depends on it.

⏺ Now let me set up dependencies — Phase 1 blocks everything, Phase 10 depends
  on all others.

⏺ Now let me start Phase 1 — the blocking build system fix. I need to read the
  current files first.

⏺ Read 5 files (ctrl+o to expand)

⏺ Now let me read the source files I'll need for later phases.

⏺ Read 12 files (ctrl+o to expand)

⏺ Good, I've read all source files. Let me now implement Phase 1 — the build
  system fix. I'll create the build script, update package.json, and delete
  vite.config.ts.

⏺ Write(packages/extension/scripts/build.mjs)
  ⎿  Wrote 114 lines to packages/extension/scripts/build.mjs
       1 /**
       2  * Multi-step Vite build for Chrome extension.
       3  *
       4  * Runs 3 separate builds to avoid Rollup code-splitting issues:
       5  * 1. Popup — React HTML app (outputs to dist/popup/)
       6  * 2. Background — ESM service worker (single file, dist/backgro
         und.js)
       7  * 3. Content — IIFE content script (single file, dist/content.j
         s)
       8  *
       9  * Then copies static assets (manifest.json, icons/, public/).
      10  */
     … +104 lines (ctrl+o to expand)

⏺ Update(packages/extension/package.json)
  ⎿  Added 2 lines, removed 2 lines
       5    "type": "module",
       6    "description": "Context Vault browser extension — inject vaul
          t context into AI chat interfaces",
       7    "scripts": {
       8 -    "dev": "vite build --watch",                               
       9 -    "build": "vite build",                                     
       8 +    "dev": "node scripts/build.mjs --watch",                   
       9 +    "build": "node scripts/build.mjs",                         
      10      "clean": "rm -rf dist"
      11    },
      12    "dependencies": {

⏺ Now delete vite.config.ts and test the build.

⏺ Bash(rm /Users/admin/dev/context-mcp/packages/extension/vite.config.ts)
  ⎿  Done

⏺ Bash(npm run build --workspace=packages/extension 2>&1)
  ⎿  > @context-vault/extension@0.1.0 build
     > node scripts/build.mjs
     … +6 lines (ctrl+o to expand)

⏺ Read 1 file (ctrl+o to expand)

⏺ Build works. manifest.json, background.js, content.js, and popup/index.html
  all in the right places. Phase 1 complete.

⏺ Now I'll launch parallel teammates for Phases 2-9 since they're all unblocked.
   Let me group them efficiently — some are small enough to combine.

⏺ 5 Task agents launched (ctrl+o to expand)
   ├─ Phase 2: Generate icons
   │  ⎿  Running in the background (shift+↑ to manage)
   ├─ Phase 3: Harden manifest.json
   │  ⎿  Running in the background (shift+↑ to manage)
   ├─ Phase 4: Service worker resilience
   │  ⎿  Running in the background (shift+↑ to manage)
   ├─ Phase 5: Content script hardening
   │  ⎿  Running in the background (shift+↑ to manage)
   └─ Phases 6-9: UX, onboarding, menu, privacy
      ⎿  Running in the background (shift+↑ to manage)

⏺ Good, the icon agent has updated package.json with sharp and the icons script.
   Let me check on all background agents.

⏺ Read 5 files (ctrl+o to expand)

⏺ Agents for Phases 2-5 are complete. The Phase 6-9 agent is still running. Let
  me update the task statuses for the completed ones.

⏺ Now let me wait for the Phases 6-9 agent to complete before doing Phase 10.

⏺ Task Output a2263d6
  ⎿  Read output (ctrl+o to expand)
  ⎿  You've hit your limit · resets 11am (Europe/Stockholm)
     /extra-usage to finish what you’re working on.

✻ Baked for 7m 13s

⏺ Agent "Phase 3: Harden manifest.json" completed
  ⎿  You've hit your limit · resets 11am (Europe/Stockholm)
     /extra-usage to finish what you’re working on.

⏺ Agent "Phase 2: Generate icons" completed
  ⎿  You've hit your limit · resets 11am (Europe/Stockholm)
     /extra-usage to finish what you’re working on.

⏺ Agent "Phase 4: Service worker resilience" completed
  ⎿  You've hit your limit · resets 11am (Europe/Stockholm)
     /extra-usage to finish what you’re working on.

⏺ Agent "Phase 5: Content script hardening" completed
  ⎿  You've hit your limit · resets 11am (Europe/Stockholm)
     /extra-usage to finish what you’re working on.

⏺ Agent "Phases 6-9: UX, onboarding, menu, privacy" completed
  ⎿  You've hit your limit · resets 11am (Europe/Stockholm)
     /extra-usage to finish what you’re working on.

❯ /plan 
  ⎿  Enabled plan mode