<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>context-mcp</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, system-ui, 'Segoe UI', sans-serif;
    background: #0a0a0a;
    color: #e5e5e5;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* ─── Layout ──────────────────────────────────────────────── */

  .app {
    display: grid;
    grid-template-columns: 240px 1fr;
    grid-template-rows: auto 1fr;
    min-height: 100vh;
  }

  header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid #222;
    background: #111;
    gap: 12px;
  }

  header h1 {
    font-size: 15px;
    font-weight: 600;
    color: #999;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  header h1 span { color: #e5e5e5; }

  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .connection-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: #666;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    padding: 4px 10px;
    border-radius: 12px;
    cursor: pointer;
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .connection-pill:hover { border-color: #444; color: #999; }

  .connection-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #3b7;
    flex-shrink: 0;
  }

  .connection-dot.disconnected { background: #c44; }

  .search-box {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #e5e5e5;
    padding: 6px 12px;
    font-size: 13px;
    width: 300px;
    outline: none;
    font-family: inherit;
  }

  .search-box:focus { border-color: #555; }
  .search-box::placeholder { color: #555; }

  /* ─── Sidebar ─────────────────────────────────────────────── */

  .sidebar {
    border-right: 1px solid #222;
    padding: 12px 0;
    overflow-y: auto;
    background: #0e0e0e;
  }

  .sidebar-section {
    padding: 6px 16px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #555;
    margin-top: 8px;
  }

  .sidebar-section:first-child { margin-top: 0; }

  .sidebar a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 16px;
    color: #aaa;
    text-decoration: none;
    font-size: 13px;
    cursor: pointer;
    border-left: 3px solid transparent;
  }

  .sidebar a:hover { background: #1a1a1a; color: #e5e5e5; }
  .sidebar a.active { color: #fff; border-left-color: #fff; background: #1a1a1a; }

  .sidebar a.indent { padding-left: 28px; font-size: 12px; color: #777; }
  .sidebar a.indent:hover { color: #ccc; }
  .sidebar a.indent.active { color: #fff; }

  .sidebar .count {
    font-size: 11px;
    color: #555;
    background: #1a1a1a;
    padding: 1px 6px;
    border-radius: 8px;
    flex-shrink: 0;
  }

  .sidebar a.active .count { color: #888; }

  .sidebar .db-info {
    padding: 12px 16px;
    font-size: 11px;
    color: #444;
    border-top: 1px solid #222;
    margin-top: 12px;
    word-break: break-all;
  }

  .sidebar .db-info div { margin-bottom: 2px; }

  /* ─── Main Content ────────────────────────────────────────── */

  .main {
    padding: 16px 24px;
    overflow-y: auto;
  }

  .main-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    font-size: 12px;
    color: #555;
  }

  /* ─── Row Cards (generic) ────────────────────────────────── */

  .row-card {
    background: #141414;
    border: 1px solid #222;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .row-card:hover { border-color: #333; }
  .row-card.expanded { border-color: #444; }

  .row-title {
    font-size: 14px;
    font-weight: 500;
    color: #e5e5e5;
    margin-bottom: 6px;
    line-height: 1.4;
  }

  .row-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 12px;
    color: #666;
  }

  .badge {
    font-size: 11px;
    padding: 1px 8px;
    border-radius: 4px;
    font-weight: 500;
    color: #fff;
  }

  .tag {
    font-size: 11px;
    color: #666;
    background: #1a1a1a;
    padding: 1px 6px;
    border-radius: 3px;
  }

  .row-detail {
    display: none;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #222;
  }

  .row-card.expanded .row-detail { display: block; }

  .row-body {
    font-size: 13px;
    color: #ccc;
    word-break: break-word;
    line-height: 1.6;
    max-height: 400px;
    overflow-y: auto;
  }

  .row-body.raw { white-space: pre-wrap; }

  .row-body h1, .row-body h2, .row-body h3 { color: #e5e5e5; margin: 12px 0 6px; }
  .row-body h1 { font-size: 16px; }
  .row-body h2 { font-size: 14px; }
  .row-body h3 { font-size: 13px; }
  .row-body p { margin: 6px 0; }
  .row-body ul, .row-body ol { padding-left: 20px; margin: 6px 0; }
  .row-body code { background: #1a1a1a; padding: 1px 4px; border-radius: 3px; font-size: 12px; }
  .row-body pre { background: #1a1a1a; border: 1px solid #222; border-radius: 6px; padding: 10px; overflow-x: auto; margin: 8px 0; }
  .row-body pre code { background: none; padding: 0; }
  .row-body a { color: #6ad; }
  .row-body blockquote { border-left: 3px solid #333; padding-left: 12px; color: #888; margin: 8px 0; }
  .row-body table { border-collapse: collapse; margin: 8px 0; }
  .row-body th, .row-body td { border: 1px solid #333; padding: 4px 8px; font-size: 12px; }
  .row-body th { background: #1a1a1a; color: #aaa; }

  .raw-toggle {
    font-size: 11px;
    color: #666;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    padding: 2px 8px;
    border-radius: 3px;
    cursor: pointer;
    float: right;
    margin-bottom: 6px;
  }
  .raw-toggle:hover { border-color: #444; color: #999; }

  .file-preview.rendered h1, .file-preview.rendered h2, .file-preview.rendered h3 { color: #e5e5e5; margin: 12px 0 6px; }
  .file-preview.rendered p { margin: 6px 0; }
  .file-preview.rendered code { background: #1a1a1a; padding: 1px 4px; border-radius: 3px; font-size: 12px; }
  .file-preview.rendered pre { background: #0a0a0a; border: 1px solid #222; border-radius: 6px; padding: 10px; overflow-x: auto; margin: 8px 0; }
  .file-preview.rendered pre code { background: none; padding: 0; }
  .file-preview.rendered a { color: #6ad; }
  .file-preview.rendered ul, .file-preview.rendered ol { padding-left: 20px; margin: 6px 0; }
  .file-preview.rendered blockquote { border-left: 3px solid #333; padding-left: 12px; color: #888; margin: 8px 0; }
  .file-preview.rendered { white-space: normal; font-family: -apple-system, system-ui, 'Segoe UI', sans-serif; }

  .row-field {
    margin-top: 8px;
    font-size: 12px;
    color: #555;
    line-height: 1.5;
  }

  .row-field strong { color: #777; }

  /* ─── Settings View ──────────────────────────────────────── */

  .settings-section {
    margin-bottom: 24px;
  }

  .settings-section h2 {
    font-size: 14px;
    font-weight: 600;
    color: #ccc;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #222;
  }

  .settings-field {
    margin-bottom: 12px;
  }

  .settings-field label {
    display: block;
    font-size: 12px;
    color: #888;
    margin-bottom: 4px;
    font-weight: 500;
  }

  .settings-field input {
    width: 100%;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #e5e5e5;
    padding: 8px 12px;
    font-size: 13px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    outline: none;
  }

  .settings-field input:focus { border-color: #555; }

  .settings-field .field-hint {
    font-size: 11px;
    color: #444;
    margin-top: 3px;
  }

  .settings-field .field-status {
    font-size: 11px;
    margin-top: 3px;
  }

  .field-status.ok { color: #3b7; }
  .field-status.warn { color: #c93; }

  .settings-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .btn {
    background: #1a1a1a;
    border: 1px solid #333;
    color: #ccc;
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
    transition: all 0.15s;
  }

  .btn:hover { border-color: #555; color: #fff; }

  .btn-primary {
    background: #1a3a2a;
    border-color: #2a5a3a;
    color: #6d9;
  }

  .btn-primary:hover { background: #1d4430; border-color: #3a7a4a; }

  .settings-toast {
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    margin-top: 12px;
    display: none;
  }

  .settings-toast.success { display: block; background: #1a3a2a; border: 1px solid #2a5a3a; color: #6d9; }
  .settings-toast.error { display: block; background: #3a1a1a; border: 1px solid #5a2a2a; color: #d66; }

  /* ─── Schema Cards ────────────────────────────────────────── */

  .table-card {
    background: #141414;
    border: 1px solid #222;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .table-card:hover { border-color: #333; }

  .schema-section-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #555;
    margin: 16px 0 8px;
  }
  .schema-section-label:first-child { margin-top: 0; }

  .internal-toggle {
    cursor: pointer;
    user-select: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .internal-toggle .arrow { transition: transform 0.15s; font-size: 9px; }
  .internal-toggle .arrow.open { transform: rotate(90deg); }

  .internal-tables { display: none; }
  .internal-tables.open { display: block; }

  .internal-tables .table-card {
    opacity: 0.5;
    padding: 8px 12px;
    cursor: pointer;
  }
  .internal-tables .table-card:hover { opacity: 0.75; border-color: #333; }
  .internal-tables .table-name { font-size: 12px; }
  .internal-tables .table-columns { display: none; }

  .table-name {
    font-size: 14px;
    font-weight: 500;
    color: #e5e5e5;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .table-name .badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 3px;
    background: #1a2a3a;
    color: #6ad;
  }

  .table-columns {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 6px;
  }

  .table-col {
    font-size: 11px;
    color: #888;
    background: #1a1a1a;
    padding: 2px 8px;
    border-radius: 3px;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .table-col .col-type {
    color: #555;
    margin-left: 4px;
  }

  /* ─── File Browser ───────────────────────────────────────── */

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 12px;
    font-size: 12px;
    flex-wrap: wrap;
  }

  .breadcrumb a {
    color: #6ad;
    text-decoration: none;
    cursor: pointer;
  }

  .breadcrumb a:hover { text-decoration: underline; }
  .breadcrumb .sep { color: #444; }

  .file-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    color: #ccc;
  }

  .file-item:hover { background: #1a1a1a; }

  .file-icon { font-size: 14px; width: 20px; text-align: center; flex-shrink: 0; }
  .file-name { flex: 1; }
  .file-meta { font-size: 11px; color: #555; }

  .file-preview {
    background: #141414;
    border: 1px solid #222;
    border-radius: 8px;
    padding: 16px;
    margin-top: 8px;
    font-size: 13px;
    color: #ccc;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.6;
    max-height: 600px;
    overflow-y: auto;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  /* ─── Pagination ──────────────────────────────────────────── */

  .pagination {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    justify-content: center;
  }

  .pagination button {
    background: #1a1a1a;
    border: 1px solid #333;
    color: #aaa;
    padding: 4px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-family: inherit;
  }

  .pagination button:hover { border-color: #555; color: #e5e5e5; }
  .pagination button:disabled { opacity: 0.3; cursor: default; }

  /* ─── Empty State ─────────────────────────────────────────── */

  .empty {
    text-align: center;
    padding: 60px 20px;
    color: #444;
    font-size: 14px;
    line-height: 1.8;
  }

  /* ─── Responsive ──────────────────────────────────────────── */

  @media (max-width: 700px) {
    .app { grid-template-columns: 1fr; }
    .sidebar {
      display: flex;
      overflow-x: auto;
      border-right: none;
      border-bottom: 1px solid #222;
      padding: 8px 12px;
      gap: 4px;
    }
    .sidebar-section { display: none; }
    .sidebar .db-info { display: none; }
    .sidebar a {
      padding: 4px 10px;
      border-left: none;
      border-radius: 4px;
      white-space: nowrap;
    }
    .sidebar a.indent { padding-left: 10px; }
    .sidebar a.active { background: #222; border-left: none; }
    .search-box { width: 180px; }
    .main { padding: 12px; }
    .connection-pill { display: none; }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1><span>context</span>-mcp</h1>
    <div class="header-right">
      <div class="connection-pill" id="connection-pill" title="Click for settings">
        <span class="connection-dot" id="connection-dot"></span>
        <span id="connection-label">connecting...</span>
      </div>
      <input type="text" class="search-box" id="search" placeholder="Search vault...">
    </div>
  </header>

  <nav class="sidebar" id="sidebar">
    <!-- Fully built by JS from /api/discover -->
  </nav>

  <main class="main" id="main">
    <div class="empty">Loading...</div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script>
/* biome-ignore lint: temporarily disabled */
(function() {
  // ─── State ──────────────────────────────────────────────────

  let discovery = null;       // Full discovery response
  let connectionInfo = null;

  // Current view state
  let view = { type: "table", table: "", groupCol: "", groupVal: "", query: "", offset: 0 };
  const LIMIT = 50;

  // ─── API ────────────────────────────────────────────────────

  async function api(path, opts) {
    const res = await fetch(path, opts);
    if (!res.ok) throw new Error(`API ${res.status}`);
    return res.json();
  }

  // ─── Utilities ──────────────────────────────────────────────

  function esc(s) {
    if (s == null) return "";
    return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
  }

  function tryParse(s) {
    if (!s || typeof s !== "string") return s;
    try { return JSON.parse(s); } catch { return s; }
  }

  function strColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    const h = Math.abs(hash) % 360;
    return `hsl(${h}, 50%, 35%)`;
  }

  function fmtDate(d) {
    if (!d) return "";
    return String(d).slice(0, 10);
  }

  function fmtSize(bytes) {
    if (!bytes) return "";
    if (bytes < 1024) return bytes + "B";
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + "KB";
    return (bytes / (1024 * 1024)).toFixed(1) + "MB";
  }

  function shortPath(p) {
    if (!p) return "";
    const home = p.match(/^\/Users\/[^/]+|^\/home\/[^/]+/);
    if (home) return p.replace(home[0], "~");
    return p;
  }

  function truncate(s, n) {
    if (!s) return "";
    return s.length > n ? s.slice(0, n) + "..." : s;
  }

  // ─── Column Role Detection ─────────────────────────────────
  // Given a list of column definitions, figure out which columns serve
  // as title, body, badge, tags, date, etc. — no hardcoded table names.

  const TITLE_NAMES = ["title", "name", "subject", "label", "heading", "summary"];
  const BODY_NAMES = ["body", "content", "text", "description", "rationale", "message", "note", "notes"];
  const BADGE_NAMES = ["kind", "type", "category", "status", "level", "group", "role"];
  const TAG_NAMES = ["tags", "labels", "keywords", "categories"];
  const DATE_NAMES = ["created_at", "updated_at", "date", "timestamp", "created", "modified", "time"];
  const PATH_NAMES = ["file_path", "path", "filepath", "url", "uri", "link"];
  const ID_NAMES = ["id", "uuid", "uid", "rowid", "pk"];
  const SKIP_IN_META = new Set([...ID_NAMES, "rowid", "embedding", "rank"]);

  function detectRoles(columns) {
    const names = columns.map((c) => c.name.toLowerCase());
    const find = (candidates) => {
      for (const cand of candidates) {
        const idx = names.indexOf(cand);
        if (idx !== -1) return columns[idx].name;
      }
      return null;
    };
    return {
      title: find(TITLE_NAMES),
      body: find(BODY_NAMES),
      badge: find(BADGE_NAMES),
      tags: find(TAG_NAMES),
      date: find(DATE_NAMES),
      path: find(PATH_NAMES),
      id: find(ID_NAMES),
    };
  }

  // ─── Update Connection Pill ────────────────────────────────

  function updateConnectionPill(info) {
    connectionInfo = info;
    const dot = document.getElementById("connection-dot");
    const label = document.getElementById("connection-label");

    if (info && info.dbExists) {
      dot.className = "connection-dot";
      label.textContent = shortPath(info.dbPath);
      label.title = `DB: ${info.dbPath}\nVault: ${info.vaultDir}`;
    } else {
      dot.className = "connection-dot disconnected";
      label.textContent = info ? "DB not found" : "disconnected";
    }
  }

  // ─── Build Sidebar from Discovery ──────────────────────────

  function buildSidebar() {
    const sidebar = document.getElementById("sidebar");
    sidebar.innerHTML = "";

    if (!discovery) {
      sidebar.innerHTML = '<div class="db-info">Loading...</div>';
      return;
    }

    const { tables, tableGroups, directories, vaultDirName, dbSize, connection } = discovery;

    // Filter to "real" data tables (skip internal/index tables)
    const internalPrefixes = ["sqlite_", "vault_fts", "vault_vec"];
    const isInternal = (name) => {
      if (name.endsWith("_fts") || name.endsWith("_vec") || name.endsWith("_idx")) return true;
      for (const p of internalPrefixes) if (name.startsWith(p)) return true;
      return false;
    };
    const dataTables = tables.filter((t) => !isInternal(t.name) && t.count > 0);
    const emptyTables = tables.filter((t) => !isInternal(t.name) && t.count === 0);

    // ── Database section ──
    if (dataTables.length > 0) {
      addSection("Database");

      for (const t of dataTables) {
        const groups = tableGroups[t.name];

        // Table-level link: show all rows
        addLink(t.name, t.count, () => {
          view = { type: "table", table: t.name, groupCol: "", groupVal: "", query: "", offset: 0 };
          loadTableData();
        });

        // If this table has a group column, show sub-links
        if (groups && groups.groups.length > 1) {
          for (const g of groups.groups) {
            addLink(g.value || "(empty)", g.count, () => {
              view = { type: "table", table: t.name, groupCol: groups.column, groupVal: g.value, query: "", offset: 0 };
              loadTableData();
            }, true);
          }
        }
      }
    }

    // ── Files section ──
    if (connection.vaultDirExists && directories.length > 0) {
      addSection("Files");
      addLink(vaultDirName || "root", null, () => {
        view = { type: "files", browsePath: "" };
        loadFiles("");
      });
      for (const d of directories) {
        if (d.type === "directory") {
          addLink(d.name, d.fileCount || null, () => {
            view = { type: "files", browsePath: d.name };
            loadFiles(d.name);
          }, true);
        }
      }
    }

    // ── System section ──
    addSection("System");
    if (tables.length > 0) {
      addLink("Schema", tables.length, () => {
        view = { type: "schema" };
        loadSchema();
      });
    }
    addLink("Settings", null, () => {
      view = { type: "settings" };
      loadSettings();
    });

    // ── DB info footer ──
    const info = document.createElement("div");
    info.className = "db-info";
    info.innerHTML = `
      <div>DB: ${esc(dbSize)}</div>
      <div style="margin-top:4px;font-size:10px;color:#333">${esc(shortPath(connection.vaultDir))}</div>
    `;
    sidebar.appendChild(info);

    // ── Helpers ──
    function addSection(label) {
      const el = document.createElement("div");
      el.className = "sidebar-section";
      el.textContent = label;
      sidebar.appendChild(el);
    }

    function addLink(label, count, onClick, indent) {
      const a = document.createElement("a");
      a.href = "#";
      a.className = indent ? "indent" : "";
      a.innerHTML = `${esc(label)}${count != null ? ` <span class="count">${count}</span>` : ""}`;
      a.addEventListener("click", (e) => {
        e.preventDefault();
        setActiveNav(a);
        onClick();
      });
      sidebar.appendChild(a);
    }
  }

  function setActiveNav(el) {
    document.querySelectorAll(".sidebar a").forEach((a) => a.classList.remove("active"));
    if (el) el.classList.add("active");
  }

  // ─── Render Table Data (generic) ───────────────────────────

  async function loadTableData() {
    const { table, groupCol, groupVal, query, offset } = view;
    const params = new URLSearchParams({ table, limit: LIMIT, offset: offset || 0 });
    if (groupCol && groupVal) {
      params.set("groupCol", groupCol);
      params.set("groupVal", groupVal);
    }
    if (query) params.set("q", query);

    try {
      const data = await api(`/api/table-data?${params}`);
      const main = document.getElementById("main");
      const roles = detectRoles(data.columns);

      if (!data.rows.length) {
        main.innerHTML = `<div class="empty">${query ? "No rows matching your search" : "No data"}</div>`;
        return;
      }

      // Header
      const label = groupVal ? `${esc(table)} / ${esc(groupVal)}` : esc(table);
      const searchNote = query ? ` matching "${esc(query)}"` : "";
      const totalPages = Math.ceil(data.total / LIMIT);
      const currentPage = Math.floor((offset || 0) / LIMIT) + 1;
      let html = `<div class="main-header">
        <span>${data.total} row${data.total === 1 ? "" : "s"} in ${label}${searchNote}</span>
        ${totalPages > 1 ? `<span>Page ${currentPage} of ${totalPages}</span>` : ""}
      </div>`;

      // Render each row as a card
      html += data.rows.map((row) => renderRowCard(row, data.columns, roles)).join("");

      // Pagination
      if (totalPages > 1) {
        html += `<div class="pagination">
          <button id="prev-page" ${currentPage <= 1 ? "disabled" : ""}>Prev</button>
          <button id="next-page" ${currentPage >= totalPages ? "disabled" : ""}>Next</button>
        </div>`;
      }

      main.innerHTML = html;

      // Bind expand/collapse
      main.querySelectorAll(".row-card").forEach((card) => {
        card.addEventListener("click", () => card.classList.toggle("expanded"));
      });

      // Bind pagination
      const prev = document.getElementById("prev-page");
      const next = document.getElementById("next-page");
      if (prev) prev.addEventListener("click", () => { view.offset = (view.offset || 0) - LIMIT; loadTableData(); });
      if (next) next.addEventListener("click", () => { view.offset = (view.offset || 0) + LIMIT; loadTableData(); });
    } catch (e) {
      document.getElementById("main").innerHTML = `<div class="empty">Failed to load data: ${esc(e.message)}</div>`;
    }
  }

  function renderRowCard(row, columns, roles) {
    // Title: use detected title column, or first non-empty text-ish value
    let titleText = "";
    if (roles.title && row[roles.title]) {
      titleText = truncate(String(row[roles.title]), 150);
    } else if (roles.body && row[roles.body]) {
      titleText = truncate(String(row[roles.body]), 120);
    } else {
      // Fallback: first non-null non-id value
      for (const col of columns) {
        if (SKIP_IN_META.has(col.name.toLowerCase())) continue;
        if (row[col.name] != null && String(row[col.name]).length > 0) {
          titleText = truncate(String(row[col.name]), 120);
          break;
        }
      }
    }
    if (!titleText) titleText = "(empty)";

    // Badge: group/type column
    let badgeHtml = "";
    if (roles.badge && row[roles.badge]) {
      const val = String(row[roles.badge]);
      badgeHtml = `<span class="badge" style="background:${strColor(val)}">${esc(val)}</span>`;
    }

    // Tags
    let tagsHtml = "";
    if (roles.tags && row[roles.tags]) {
      const parsed = tryParse(row[roles.tags]);
      const arr = Array.isArray(parsed) ? parsed : (typeof parsed === "string" ? parsed.split(",").map((s) => s.trim()) : []);
      tagsHtml = arr.filter(Boolean).map((t) => `<span class="tag">${esc(String(t))}</span>`).join("");
    }

    // Date
    let dateHtml = "";
    if (roles.date && row[roles.date]) {
      dateHtml = `<span>${esc(fmtDate(row[roles.date]))}</span>`;
    }

    // Body for expanded detail (markdown rendered)
    let bodyHtml = "";
    if (roles.body && row[roles.body]) {
      const rawText = String(row[roles.body]);
      const rendered = typeof marked !== "undefined" ? marked.parse(rawText) : esc(rawText);
      bodyHtml = `<button class="raw-toggle" onclick="event.stopPropagation(); this.parentElement.querySelector('.row-body').classList.toggle('raw'); this.textContent = this.textContent === 'Raw' ? 'Rendered' : 'Raw'">Raw</button>
        <div class="row-body">${rendered}</div>`;
    }

    // All other fields as metadata
    const shownKeys = new Set([roles.title, roles.body, roles.badge, roles.tags, roles.date].filter(Boolean));
    let metaHtml = "";
    for (const col of columns) {
      const key = col.name;
      if (shownKeys.has(key)) continue;
      if (SKIP_IN_META.has(key.toLowerCase())) continue;
      if (row[key] == null || String(row[key]).length === 0) continue;

      let val = row[key];
      // Try to display parsed JSON objects nicely
      const parsed = tryParse(val);
      if (parsed && typeof parsed === "object" && !Array.isArray(parsed)) {
        for (const [k, v] of Object.entries(parsed)) {
          if (v != null) metaHtml += `<div class="row-field"><strong>${esc(k)}:</strong> ${esc(String(v))}</div>`;
        }
      } else {
        metaHtml += `<div class="row-field"><strong>${esc(key)}:</strong> ${esc(truncate(String(val), 500))}</div>`;
      }
    }

    return `<div class="row-card">
      <div class="row-title">${esc(titleText)}</div>
      <div class="row-meta">${badgeHtml}${tagsHtml}${dateHtml}</div>
      <div class="row-detail">${bodyHtml}${metaHtml}</div>
    </div>`;
  }

  // ─── Schema View ───────────────────────────────────────────

  function loadSchema() {
    const main = document.getElementById("main");
    if (!discovery || !discovery.tables.length) {
      main.innerHTML = `<div class="empty">No tables found in database</div>`;
      return;
    }

    const internalPrefixes = ["sqlite_", "vault_fts", "vault_vec"];
    const isInternal = (name) => {
      if (name.endsWith("_fts") || name.endsWith("_vec") || name.endsWith("_idx")) return true;
      for (const p of internalPrefixes) if (name.startsWith(p)) return true;
      return false;
    };

    const userTables = discovery.tables.filter((t) => !isInternal(t.name));
    const internalTables = discovery.tables.filter((t) => isInternal(t.name));

    const renderCard = (t) => {
      const cols = t.columns.map((c) =>
        `<span class="table-col">${esc(c.name)}<span class="col-type">${esc(c.type || "")}</span></span>`
      ).join("");
      return `<div class="table-card" data-table="${esc(t.name)}">
        <div class="table-name">
          ${esc(t.name)}
          <span class="badge" style="background:#1a2a3a;color:#6ad">${esc(t.type)}</span>
          <span style="font-size:12px;color:#666;font-weight:normal">${t.count} rows</span>
        </div>
        <div class="table-columns">${cols}</div>
      </div>`;
    };

    const headerText = `${userTables.length} table${userTables.length !== 1 ? "s" : ""}` +
      (internalTables.length ? ` · ${internalTables.length} internal` : "");
    const header = `<div class="main-header"><span>${headerText}</span></div>`;

    const userSection = `<div class="schema-section-label">Tables</div>` +
      userTables.map(renderCard).join("");

    const internalSection = internalTables.length ? (
      `<div class="schema-section-label">` +
        `<span class="internal-toggle" id="internal-toggle">` +
          `<span class="arrow">▶</span> Internal (${internalTables.length})` +
        `</span>` +
      `</div>` +
      `<div class="internal-tables" id="internal-tables">` +
        internalTables.map(renderCard).join("") +
      `</div>`
    ) : "";

    main.innerHTML = header + userSection + internalSection;

    // Toggle internal section
    const toggle = document.getElementById("internal-toggle");
    const container = document.getElementById("internal-tables");
    if (toggle && container) {
      toggle.addEventListener("click", () => {
        container.classList.toggle("open");
        toggle.querySelector(".arrow").classList.toggle("open");
      });
    }

    // Click to navigate to table data
    main.querySelectorAll(".table-card").forEach((card) => {
      card.addEventListener("click", () => {
        const tableName = card.dataset.table;
        view = { type: "table", table: tableName, groupCol: "", groupVal: "", query: "", offset: 0 };
        buildSidebar();
        loadTableData();
      });
    });
  }

  // ─── File Browser ──────────────────────────────────────────

  async function loadFiles(browsePath) {
    view.browsePath = browsePath || "";
    try {
      const params = new URLSearchParams();
      if (view.browsePath) params.set("path", view.browsePath);

      const data = await api(`/api/browse?${params}`);
      const main = document.getElementById("main");
      const rootLabel = data.baseName || "files";

      if (!data.exists) {
        main.innerHTML = `<div class="empty">Directory not found<br><span style="font-size:12px;color:#555;margin-top:8px;display:block">${esc(data.path)}</span></div>`;
        return;
      }

      // Breadcrumb
      let breadcrumb = `<div class="breadcrumb">`;
      breadcrumb += `<a onclick="window.__browse('')">${esc(rootLabel)}</a>`;
      if (view.browsePath) {
        const parts = view.browsePath.split("/").filter(Boolean);
        let accumulated = "";
        for (const part of parts) {
          accumulated += (accumulated ? "/" : "") + part;
          const p = accumulated;
          breadcrumb += `<span class="sep">/</span><a onclick="window.__browse('${esc(p)}')">${esc(part)}</a>`;
        }
      }
      breadcrumb += `</div>`;

      if (!data.items.length) {
        main.innerHTML = breadcrumb + `<div class="empty" style="padding:30px">Empty directory</div>`;
        return;
      }

      const items = data.items.map((item) => {
        if (item.type === "directory") {
          return `<div class="file-item" onclick="window.__browse('${esc(item.path)}')">
            <span class="file-icon" style="color:#6ad">&#128193;</span>
            <span class="file-name">${esc(item.name)}</span>
            <span class="file-meta">${item.childCount} items</span>
          </div>`;
        }
        return `<div class="file-item" onclick="window.__preview('${esc(item.path)}')">
          <span class="file-icon" style="color:#888">&#128196;</span>
          <span class="file-name">${esc(item.name)}</span>
          <span class="file-meta">${fmtSize(item.size)}</span>
        </div>`;
      }).join("");

      main.innerHTML = breadcrumb + items;
    } catch (e) {
      document.getElementById("main").innerHTML = `<div class="empty">Failed to browse: ${esc(e.message)}</div>`;
    }
  }

  async function previewFile(path) {
    try {
      const data = await api(`/api/file?path=${encodeURIComponent(path)}`);
      const main = document.getElementById("main");
      const rootLabel = data.baseName || "files";

      let breadcrumb = `<div class="breadcrumb">`;
      breadcrumb += `<a onclick="window.__browse('')">${esc(rootLabel)}</a>`;
      const parts = path.split("/").filter(Boolean);
      let accumulated = "";
      for (let i = 0; i < parts.length - 1; i++) {
        accumulated += (accumulated ? "/" : "") + parts[i];
        const p = accumulated;
        breadcrumb += `<span class="sep">/</span><a onclick="window.__browse('${esc(p)}')">${esc(parts[i])}</a>`;
      }
      breadcrumb += `<span class="sep">/</span><span style="color:#e5e5e5">${esc(parts[parts.length - 1])}</span>`;
      breadcrumb += `</div>`;

      const meta = `<div style="font-size:11px;color:#555;margin-bottom:12px;display:flex;gap:12px">
        <span>${fmtSize(data.size)}</span>
        <span>Modified: ${fmtDate(data.modified)}</span>
      </div>`;

      const rendered = typeof marked !== "undefined" ? marked.parse(data.content) : esc(data.content);
      main.innerHTML = breadcrumb + meta +
        `<button class="raw-toggle" onclick="var fp=document.getElementById('file-preview'); fp.classList.toggle('rendered'); fp.classList.toggle('raw'); if(fp.classList.contains('raw')){fp.innerHTML=window.__fileRawHtml}else{fp.innerHTML=window.__fileRenderedHtml}; this.textContent=fp.classList.contains('raw')?'Rendered':'Raw'">Raw</button>` +
        `<div class="file-preview rendered" id="file-preview">${rendered}</div>`;
      window.__fileRawHtml = esc(data.content);
      window.__fileRenderedHtml = rendered;
    } catch (e) {
      document.getElementById("main").innerHTML = `<div class="empty">Failed to load file: ${esc(e.message)}</div>`;
    }
  }

  window.__browse = (p) => {
    view = { type: "files", browsePath: p };
    loadFiles(p);
  };
  window.__preview = previewFile;

  // ─── Settings View ─────────────────────────────────────────

  async function loadSettings() {
    try {
      const data = await api("/api/config");
      const main = document.getElementById("main");
      const active = data.active || {};
      const saved = data.config || {};

      main.innerHTML = `
        <div class="main-header"><span>Settings</span></div>
        <div class="settings-section">
          <h2>Paths</h2>
          <div class="settings-field">
            <label>Vault Directory</label>
            <input type="text" id="cfg-vaultDir" value="${esc(active.vaultDir || saved.vaultDir || "")}" placeholder="/path/to/vault">
            <div class="field-hint">Root directory for markdown knowledge files. Any folder structure is supported.</div>
            <div class="field-status" id="status-vaultDir"></div>
          </div>
          <div class="settings-field">
            <label>Database Path</label>
            <input type="text" id="cfg-dbPath" value="${esc(active.dbPath || saved.dbPath || "")}" placeholder="/path/to/vault.db">
            <div class="field-hint">Any SQLite database. Tables and columns are auto-detected.</div>
            <div class="field-status" id="status-dbPath"></div>
          </div>
          <div class="settings-field">
            <label>Data Directory</label>
            <input type="text" id="cfg-dataDir" value="${esc(active.dataDir || saved.dataDir || "")}" placeholder="/path/to/.context-mcp">
            <div class="field-hint">Directory for database and configuration storage.</div>
          </div>
          <div class="settings-field">
            <label>Dev Directory</label>
            <input type="text" id="cfg-devDir" value="${esc(active.devDir || saved.devDir || "")}" placeholder="/path/to/dev">
            <div class="field-hint">Root development directory used for project discovery.</div>
          </div>
          <div class="settings-actions">
            <button class="btn btn-primary" id="save-config">Save &amp; Reconnect</button>
          </div>
          <div class="settings-toast" id="settings-toast"></div>
        </div>

        <div class="settings-section">
          <h2>Active Connection</h2>
          <div style="font-size:13px;color:#888;line-height:1.8">
            <div><strong style="color:#aaa">Database:</strong> ${esc(active.dbPath || "not set")}</div>
            <div><strong style="color:#aaa">Vault:</strong> ${esc(active.vaultDir || "not set")}</div>
            <div><strong style="color:#aaa">Data:</strong> ${esc(active.dataDir || "not set")}</div>
            <div><strong style="color:#aaa">Dev:</strong> ${esc(active.devDir || "not set")}</div>
            <div style="margin-top:8px;font-size:11px;color:#555">Config file: ${esc(data.path || "")}</div>
          </div>
        </div>
      `;

      // Path validation
      if (connectionInfo) {
        const vd = document.getElementById("status-vaultDir");
        const dp = document.getElementById("status-dbPath");
        vd.className = connectionInfo.vaultDirExists ? "field-status ok" : "field-status warn";
        vd.textContent = connectionInfo.vaultDirExists ? "Directory exists" : "Directory not found";
        dp.className = connectionInfo.dbExists ? "field-status ok" : "field-status warn";
        dp.textContent = connectionInfo.dbExists ? "Database connected" : "Database will be created";
      }

      // Save
      document.getElementById("save-config").addEventListener("click", async () => {
        const toast = document.getElementById("settings-toast");
        try {
          const newConfig = {};
          for (const key of ["vaultDir", "dbPath", "dataDir", "devDir"]) {
            const val = document.getElementById("cfg-" + key).value.trim();
            if (val) newConfig[key] = val;
          }

          await api("/api/config", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newConfig),
          });

          toast.className = "settings-toast success";
          toast.textContent = "Saved. Reloading...";

          // Full reload
          await init();
          setTimeout(() => loadSettings(), 300);
        } catch (e) {
          toast.className = "settings-toast error";
          toast.textContent = "Failed: " + e.message;
        }
      });
    } catch (e) {
      document.getElementById("main").innerHTML = `<div class="empty">Failed to load settings: ${esc(e.message)}</div>`;
    }
  }

  // ─── Search ────────────────────────────────────────────────

  // ─── Semantic Search ──────────────────────────────────────

  async function loadSearchResults(query) {
    try {
      const data = await api(`/api/search?q=${encodeURIComponent(query)}`);
      const main = document.getElementById("main");

      if (!data.results || !data.results.length) {
        main.innerHTML = `<div class="empty">No results for "${esc(query)}"</div>`;
        return;
      }

      let html = `<div class="main-header"><span>${data.results.length} result${data.results.length === 1 ? "" : "s"} for "${esc(query)}"</span></div>`;

      html += data.results.map((row) => {
        const titleText = row.title ? truncate(String(row.title), 150) : truncate(String(row.body || ""), 120);
        const badgeHtml = row.kind ? `<span class="badge" style="background:${strColor(row.kind)}">${esc(row.kind)}</span>` : "";
        const scoreHtml = `<span style="font-size:11px;color:#555">score: ${row.score.toFixed(3)}</span>`;

        let tagsHtml = "";
        if (row.tags) {
          const parsed = tryParse(row.tags);
          const arr = Array.isArray(parsed) ? parsed : (typeof parsed === "string" ? parsed.split(",").map((s) => s.trim()) : []);
          tagsHtml = arr.filter(Boolean).map((t) => `<span class="tag">${esc(String(t))}</span>`).join("");
        }

        const dateHtml = row.created_at ? `<span>${esc(fmtDate(row.created_at))}</span>` : "";

        let bodyHtml = "";
        if (row.body) {
          const rawText = String(row.body);
          const rendered = typeof marked !== "undefined" ? marked.parse(rawText) : esc(rawText);
          bodyHtml = `<button class="raw-toggle" onclick="event.stopPropagation(); this.parentElement.querySelector('.row-body').classList.toggle('raw'); this.textContent = this.textContent === 'Raw' ? 'Rendered' : 'Raw'">Raw</button>
            <div class="row-body">${rendered}</div>`;
        }

        let metaHtml = "";
        if (row.file_path) metaHtml += `<div class="row-field"><strong>file:</strong> ${esc(String(row.file_path))}</div>`;
        if (row.meta) {
          const parsed = tryParse(row.meta);
          if (parsed && typeof parsed === "object") {
            for (const [k, v] of Object.entries(parsed)) {
              if (v != null) metaHtml += `<div class="row-field"><strong>${esc(k)}:</strong> ${esc(String(v))}</div>`;
            }
          }
        }

        return `<div class="row-card">
          <div class="row-title">${esc(titleText || "(empty)")}</div>
          <div class="row-meta">${badgeHtml}${tagsHtml}${dateHtml}${scoreHtml}</div>
          <div class="row-detail">${bodyHtml}${metaHtml}</div>
        </div>`;
      }).join("");

      main.innerHTML = html;
      main.querySelectorAll(".row-card").forEach((card) => {
        card.addEventListener("click", () => card.classList.toggle("expanded"));
      });
    } catch (e) {
      document.getElementById("main").innerHTML = `<div class="empty">Search failed: ${esc(e.message)}</div>`;
    }
  }

  let searchTimer;
  document.getElementById("search").addEventListener("input", (e) => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      const q = e.target.value.trim();

      if (!q) {
        // Restore previous view
        if (view.type === "search" && view.prevView) {
          view = view.prevView;
        }
        if (view.type === "table") loadTableData();
        else if (view.type === "files") loadFiles(view.browsePath || "");
        return;
      }

      view = { type: "search", query: q, prevView: view.type !== "search" ? { ...view } : view.prevView };
      setActiveNav(null);
      loadSearchResults(q);
    }, 300);
  });

  // Connection pill → settings
  document.getElementById("connection-pill").addEventListener("click", () => {
    view = { type: "settings" };
    setActiveNav(null);
    loadSettings();
  });

  // ─── Init ──────────────────────────────────────────────────

  async function init() {
    try {
      discovery = await api("/api/discover");

      if (discovery.connection) {
        updateConnectionPill(discovery.connection);
      }

      buildSidebar();

      // Auto-select first view: first data table, or files, or settings
      const dataTables = discovery.tables.filter((t) =>
        !t.name.endsWith("_fts") && !t.name.endsWith("_vec") && !t.name.endsWith("_idx") && t.count > 0
      );

      if (dataTables.length > 0) {
        view = { type: "table", table: dataTables[0].name, groupCol: "", groupVal: "", query: "", offset: 0 };
        // Activate first sidebar link
        const firstLink = document.querySelector(".sidebar a:not(.indent)");
        if (firstLink) setActiveNav(firstLink);
        loadTableData();
      } else if (discovery.connection.vaultDirExists) {
        view = { type: "files", browsePath: "" };
        loadFiles("");
      } else {
        view = { type: "settings" };
        loadSettings();
        document.getElementById("main").innerHTML = `<div class="empty">
          No data found.<br>
          <span style="font-size:12px;color:#555;margin-top:8px;display:block">
            Configure your database and knowledge directory in Settings.
          </span>
        </div>`;
      }
    } catch (e) {
      updateConnectionPill(null);
      document.getElementById("main").innerHTML = `<div class="empty">
        Cannot connect to server<br>
        <span style="font-size:12px;color:#555;margin-top:8px;display:block">${esc(e.message)}</span>
      </div>`;
    }
  }

  init();
})();
</script>
</body>
</html>
